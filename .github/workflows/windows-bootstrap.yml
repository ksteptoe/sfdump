name: windows-bootstrap

on:
  push:
    branches: ['**']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test the current branch's setup.ps1 (tests latest code changes)
  test-setup-script:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run setup.ps1 -Install -SkipEnv
        shell: pwsh
        run: |
          Write-Host "Running setup.ps1 in non-interactive mode..."
          & "${{ github.workspace }}\setup.ps1" -Install -SkipEnv

      - name: Verify virtual environment created
        shell: pwsh
        run: |
          $venvPython = "${{ github.workspace }}\.venv\Scripts\python.exe"
          $venvActivate = "${{ github.workspace }}\.venv\Scripts\Activate.ps1"

          Write-Host "Checking virtual environment..."

          if (-not (Test-Path $venvPython)) {
              throw "Virtual environment python not found at: $venvPython"
          }
          Write-Host "  [OK] .venv\Scripts\python.exe exists"

          if (-not (Test-Path $venvActivate)) {
              throw "Virtual environment activate script not found at: $venvActivate"
          }
          Write-Host "  [OK] .venv\Scripts\Activate.ps1 exists"

          $version = & $venvPython --version
          Write-Host "  [OK] Python version: $version"

      - name: Verify sfdump and sf executables exist
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $sf = "${{ github.workspace }}\.venv\Scripts\sf.exe"

          Write-Host "Checking executables..."

          if (-not (Test-Path $sfdump)) {
              throw "sfdump.exe not found at: $sfdump"
          }
          Write-Host "  [OK] sfdump.exe exists"

          if (-not (Test-Path $sf)) {
              throw "sf.exe not found at: $sf"
          }
          Write-Host "  [OK] sf.exe exists (alias)"

      - name: Test sfdump --version
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $version = & $sfdump --version
          Write-Host "sfdump version: $version"
          if (-not $version) { throw "sfdump --version returned empty" }

      - name: Test sf --version (alias)
        shell: pwsh
        run: |
          $sf = "${{ github.workspace }}\.venv\Scripts\sf.exe"
          $version = & $sf --version
          Write-Host "sf version: $version"
          if (-not $version) { throw "sf --version returned empty" }

      - name: Test sfdump --help shows all commands
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump --help..."
          $output = (& $sfdump --help) -join "`n"
          Write-Host $output

          $requiredCommands = @("login", "files", "verify-files", "build-db", "db-viewer")
          foreach ($cmd in $requiredCommands) {
              if ($output -notmatch $cmd) {
                  throw "Missing '$cmd' command in sfdump --help"
              }
              Write-Host "  [OK] Found '$cmd' command"
          }

      - name: Test venv activation works
        shell: pwsh
        run: |
          Write-Host "Testing venv activation..."

          # Activate the venv
          . "${{ github.workspace }}\.venv\Scripts\Activate.ps1"

          # Verify we're in the venv
          $pythonPath = (Get-Command python).Source
          Write-Host "Python path after activation: $pythonPath"

          if ($pythonPath -notmatch "\.venv") {
              throw "Python is not from venv after activation"
          }
          Write-Host "  [OK] Venv activation works"

          # Verify sfdump is available after activation
          $sfdumpPath = (Get-Command sfdump -ErrorAction SilentlyContinue).Source
          if (-not $sfdumpPath) {
              throw "sfdump not found in PATH after venv activation"
          }
          Write-Host "  [OK] sfdump available in PATH: $sfdumpPath"

          # Run sfdump from activated venv
          $version = sfdump --version
          Write-Host "  [OK] sfdump --version from activated venv: $version"

      - name: Test sfdump login --help
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $output = (& $sfdump login --help) -join "`n"
          Write-Host $output
          if ($output -notmatch "token") { throw "login --help missing expected content" }
          Write-Host "  [OK] sfdump login --help works"

      - name: Test sfdump files --help
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $output = (& $sfdump files --help) -join "`n"
          Write-Host $output
          if ($output -notmatch "Download") { throw "files --help missing expected content" }
          Write-Host "  [OK] sfdump files --help works"

      - name: Test sfdump login runs (no credentials)
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump login (expecting credential error)..."

          # Clear any env vars that might exist
          $env:SF_CLIENT_ID = ""
          $env:SF_CLIENT_SECRET = ""
          $env:SF_LOGIN_URL = ""

          # Run login - should fail with missing credentials error
          $output = (& $sfdump login 2>&1) -join "`n"
          $exitCode = $LASTEXITCODE

          Write-Host "Output: $output"
          Write-Host "Exit code: $exitCode"

          # Verify it failed with the expected error (not a crash)
          if ($output -notmatch "SF_CLIENT_ID|SF_LOGIN_URL|Missing|credentials") {
              throw "sfdump login didn't produce expected credential error"
          }

          if ($exitCode -eq 0) {
              throw "sfdump login should have failed without credentials"
          }

          Write-Host "  [OK] sfdump login runs correctly (fails gracefully without credentials)"

          # Reset exit code so the step passes
          exit 0

  # Full end-to-end test: download release, install, and verify
  test-full-e2e:
    runs-on: windows-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download and extract release
        shell: pwsh
        run: |
          Write-Host "Downloading latest release..."

          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $headers = @{ "User-Agent" = "sfdump-ci-test" }

          # Get latest release
          try {
              $release = Invoke-RestMethod -Uri "https://api.github.com/repos/ksteptoe/sfdump/releases/latest" -Headers $headers
              Write-Host "Found release: $($release.tag_name)"
              $asset = $release.assets | Where-Object { $_.name -match "^sfdump-.*\.zip$" } | Select-Object -First 1
              if ($asset) {
                  $zipUrl = $asset.browser_download_url
              } else {
                  $zipUrl = $release.zipball_url
              }
          } catch {
              Write-Host "No releases found, using main branch"
              $zipUrl = "https://github.com/ksteptoe/sfdump/archive/refs/heads/main.zip"
          }

          # Download
          $zipPath = "$env:TEMP\sfdump-e2e.zip"
          Write-Host "Downloading: $zipUrl"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -Headers $headers

          # Extract
          $extractPath = "$env:TEMP\sfdump-e2e-extract"
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

          # Find and copy to install location
          $extractedFolder = Get-ChildItem $extractPath | Select-Object -First 1
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"
          New-Item -ItemType Directory -Path $installDir -Force | Out-Null
          Copy-Item -Path "$($extractedFolder.FullName)\*" -Destination $installDir -Recurse -Force

          Write-Host "Installed to: $installDir"

      - name: Run setup.ps1 -Install (with .env creation)
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"
          Write-Host "Running setup.ps1 -Install..."

          Push-Location $installDir
          try {
              # Run with -Install but WITHOUT -SkipEnv to test .env template creation
              # We'll need to handle the interactive prompt for .env
              # For now, use -SkipEnv since we can't interact
              & "$installDir\setup.ps1" -Install -SkipEnv
          } finally {
              Pop-Location
          }

      - name: Verify installation
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"
          $venvPython = "$installDir\.venv\Scripts\python.exe"
          $sfdump = "$installDir\.venv\Scripts\sfdump.exe"
          $sf = "$installDir\.venv\Scripts\sf.exe"

          Write-Host "Verifying installation..."

          # Check venv exists
          if (-not (Test-Path $venvPython)) { throw "venv python not found" }
          Write-Host "  [OK] .venv\Scripts\python.exe exists"

          # Check executables exist
          if (-not (Test-Path $sfdump)) { throw "sfdump.exe not found" }
          Write-Host "  [OK] sfdump.exe exists"

          if (-not (Test-Path $sf)) { throw "sf.exe not found" }
          Write-Host "  [OK] sf.exe exists"

          # Check version
          $version = & $sfdump --version
          Write-Host "  [OK] sfdump version: $version"

      - name: Test sfdump commands work
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"
          $sfdump = "$installDir\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump commands..."

          # Test --help
          $help = (& $sfdump --help) -join "`n"
          if ($help -notmatch "login") { throw "Missing login command" }
          Write-Host "  [OK] --help works"

          # Test login --help
          $loginHelp = (& $sfdump login --help) -join "`n"
          if ($loginHelp -notmatch "token") { throw "login --help missing content" }
          Write-Host "  [OK] login --help works"

          # Test files --help
          $filesHelp = (& $sfdump files --help) -join "`n"
          if ($filesHelp -notmatch "Download") { throw "files --help missing content" }
          Write-Host "  [OK] files --help works"

          # Test build-db --help
          $buildDbHelp = (& $sfdump build-db --help) -join "`n"
          if ($buildDbHelp -notmatch "SQLite") { throw "build-db --help missing content" }
          Write-Host "  [OK] build-db --help works"

      - name: Test venv activation in e2e install
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"

          Write-Host "Testing venv activation..."

          # Change to install directory
          Push-Location $installDir
          try {
              # Activate venv
              . ".\.venv\Scripts\Activate.ps1"

              # Verify sfdump is in PATH
              $sfdumpPath = (Get-Command sfdump -ErrorAction SilentlyContinue).Source
              if (-not $sfdumpPath) { throw "sfdump not in PATH after activation" }
              Write-Host "  [OK] sfdump in PATH: $sfdumpPath"

              # Run commands
              $version = sfdump --version
              Write-Host "  [OK] sfdump --version: $version"

              $help = (sfdump --help) -join "`n"
              if ($help -notmatch "Salesforce") { throw "Help missing Salesforce" }
              Write-Host "  [OK] sfdump --help works from activated venv"
          } finally {
              Pop-Location
          }

      - name: Test sfdump login runs (no credentials)
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-e2e-test"
          $sfdump = "$installDir\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump login (expecting credential error)..."

          # Clear any env vars
          $env:SF_CLIENT_ID = ""
          $env:SF_CLIENT_SECRET = ""
          $env:SF_LOGIN_URL = ""

          # Run login - should fail with missing credentials error
          $output = (& $sfdump login 2>&1) -join "`n"
          $exitCode = $LASTEXITCODE

          Write-Host "Output: $output"
          Write-Host "Exit code: $exitCode"

          # Verify it failed with the expected error (not a crash)
          if ($output -notmatch "SF_CLIENT_ID|SF_LOGIN_URL|Missing|credentials") {
              throw "sfdump login didn't produce expected credential error"
          }

          Write-Host "  [OK] sfdump login runs correctly (fails gracefully without credentials)"

          # Reset exit code so the step passes
          exit 0

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$env:TEMP\sfdump-e2e.zip" -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\sfdump-e2e-extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:USERPROFILE\sfdump-e2e-test" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Cleanup complete"

  # Test the release download flow (simulates fresh user experience)
  test-release-download:
    runs-on: windows-latest
    steps:
      # Don't checkout - simulating a fresh user machine
      # Don't setup Python - user won't have it installed

      - name: Test bootstrap.ps1 can be downloaded
        shell: pwsh
        run: |
          Write-Host "Testing bootstrap.ps1 download from GitHub..."
          $script = irm https://raw.githubusercontent.com/ksteptoe/sfdump/main/bootstrap.ps1
          if (-not $script) { throw "Failed to download bootstrap.ps1" }
          if ($script -notmatch "sfdump") { throw "Downloaded content doesn't look like bootstrap.ps1" }
          Write-Host "Bootstrap script downloaded successfully ($($script.Length) bytes)"

      - name: Test release ZIP download
        shell: pwsh
        run: |
          Write-Host "Testing release ZIP download..."

          # Ensure TLS 1.2
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

          # Get latest release info
          $headers = @{ "User-Agent" = "sfdump-ci-test" }
          $releaseApiUrl = "https://api.github.com/repos/ksteptoe/sfdump/releases/latest"

          try {
              $release = Invoke-RestMethod -Uri $releaseApiUrl -Headers $headers -ErrorAction Stop
              Write-Host "Found release: $($release.tag_name)"

              # Look for sfdump ZIP
              $asset = $release.assets | Where-Object { $_.name -match "^sfdump-.*\.zip$" } | Select-Object -First 1

              if ($asset) {
                  $zipUrl = $asset.browser_download_url
                  Write-Host "Found ZIP asset: $($asset.name)"
              } else {
                  $zipUrl = $release.zipball_url
                  Write-Host "No ZIP asset, using source archive"
              }
          } catch {
              Write-Host "No releases found, using main branch"
              $zipUrl = "https://github.com/ksteptoe/sfdump/archive/refs/heads/main.zip"
          }

          # Download the ZIP
          $zipPath = "$env:TEMP\sfdump-test.zip"
          Write-Host "Downloading: $zipUrl"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath -Headers $headers

          if (-not (Test-Path $zipPath)) { throw "ZIP download failed" }
          $size = (Get-Item $zipPath).Length
          Write-Host "Downloaded successfully: $([math]::Round($size/1MB, 2)) MB"

      - name: Test ZIP extraction and verify contents
        shell: pwsh
        run: |
          Write-Host "Testing ZIP extraction..."

          $zipPath = "$env:TEMP\sfdump-test.zip"
          $extractPath = "$env:TEMP\sfdump-extract"
          $installDir = "$env:USERPROFILE\sfdump-test"

          # Extract
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

          # Find extracted folder
          $extractedFolder = Get-ChildItem $extractPath | Select-Object -First 1
          if (-not $extractedFolder) { throw "No files in archive" }

          Write-Host "Extracted to: $($extractedFolder.FullName)"

          # Copy to install location
          New-Item -ItemType Directory -Path $installDir -Force | Out-Null
          Copy-Item -Path "$($extractedFolder.FullName)\*" -Destination $installDir -Recurse -Force

          Write-Host "Installed to: $installDir"
          Write-Host ""
          Write-Host "Contents:"
          Get-ChildItem $installDir | ForEach-Object { Write-Host "  $_" }

      - name: Verify required files exist
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-test"

          Write-Host "Verifying required files..."

          $requiredFiles = @(
              "setup.ps1",
              "install.bat",
              "bootstrap.ps1",
              "pyproject.toml",
              "src/sfdump/cli.py"
          )

          $missing = @()
          foreach ($file in $requiredFiles) {
              $path = Join-Path $installDir $file
              if (Test-Path $path) {
                  Write-Host "  [OK] $file"
              } else {
                  Write-Host "  [MISSING] $file" -ForegroundColor Red
                  $missing += $file
              }
          }

          if ($missing.Count -gt 0) {
              throw "Missing required files: $($missing -join ', ')"
          }

          Write-Host ""
          Write-Host "All required files present!" -ForegroundColor Green

      - name: Verify setup.ps1 is valid PowerShell
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-test"
          $setupScript = Join-Path $installDir "setup.ps1"

          Write-Host "Checking setup.ps1 syntax..."

          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile($setupScript, [ref]$null, [ref]$errors)

          if ($errors.Count -gt 0) {
              Write-Host "Syntax errors found:" -ForegroundColor Red
              $errors | ForEach-Object { Write-Host "  $_" }
              throw "setup.ps1 has syntax errors"
          }

          Write-Host "setup.ps1 syntax is valid!" -ForegroundColor Green

      - name: Verify .env template in setup.ps1
        shell: pwsh
        run: |
          $installDir = "$env:USERPROFILE\sfdump-test"
          $setupScript = Join-Path $installDir "setup.ps1"

          Write-Host "Checking .env template content..."

          $content = Get-Content $setupScript -Raw

          # Verify correct environment variables are in the template
          $requiredVars = @(
              "SF_AUTH_FLOW=client_credentials",
              "SF_CLIENT_ID=",
              "SF_CLIENT_SECRET=",
              "SF_LOGIN_URL="
          )

          foreach ($var in $requiredVars) {
              if ($content -notmatch [regex]::Escape($var)) {
                  throw "Missing '$var' in .env template"
              }
              Write-Host "  [OK] Found '$var' in template"
          }

          # Verify OLD variables are NOT in the template
          $oldVars = @("SF_HOST=", "SF_USERNAME=", "SF_PASSWORD=")
          foreach ($var in $oldVars) {
              if ($content -match [regex]::Escape($var)) {
                  throw "Old variable '$var' still in .env template - should use Client Credentials flow"
              }
              Write-Host "  [OK] Old variable '$var' not in template"
          }

          Write-Host ""
          Write-Host ".env template is correct!" -ForegroundColor Green

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$env:TEMP\sfdump-test.zip" -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:TEMP\sfdump-extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$env:USERPROFILE\sfdump-test" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Cleanup complete"
