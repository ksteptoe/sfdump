name: windows-bootstrap

on:
  push:
    branches: ['**']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Test the current branch's setup.ps1 with local wheel (tests latest code changes)
  test-setup-script:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Build wheel from local source
        shell: pwsh
        run: |
          python -m pip install --upgrade pip build
          python -m build --wheel --outdir dist/

      - name: Run setup.ps1 -Install -SkipEnv (with local wheel)
        shell: pwsh
        env:
          PIP_FIND_LINKS: ${{ github.workspace }}/dist/
        run: |
          Write-Host "Running setup.ps1 in non-interactive mode..."
          & "${{ github.workspace }}\setup.ps1" -Install -SkipEnv

      - name: Verify virtual environment created
        shell: pwsh
        run: |
          $venvPython = "${{ github.workspace }}\.venv\Scripts\python.exe"
          $venvActivate = "${{ github.workspace }}\.venv\Scripts\Activate.ps1"

          Write-Host "Checking virtual environment..."

          if (-not (Test-Path $venvPython)) {
              throw "Virtual environment python not found at: $venvPython"
          }
          Write-Host "  [OK] .venv\Scripts\python.exe exists"

          if (-not (Test-Path $venvActivate)) {
              throw "Virtual environment activate script not found at: $venvActivate"
          }
          Write-Host "  [OK] .venv\Scripts\Activate.ps1 exists"

          $version = & $venvPython --version
          Write-Host "  [OK] Python version: $version"

      - name: Verify sfdump and sf executables exist
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $sf = "${{ github.workspace }}\.venv\Scripts\sf.exe"

          Write-Host "Checking executables..."

          if (-not (Test-Path $sfdump)) {
              throw "sfdump.exe not found at: $sfdump"
          }
          Write-Host "  [OK] sfdump.exe exists"

          if (-not (Test-Path $sf)) {
              throw "sf.exe not found at: $sf"
          }
          Write-Host "  [OK] sf.exe exists (alias)"

      - name: Test sfdump --version
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $version = & $sfdump --version
          Write-Host "sfdump version: $version"
          if (-not $version) { throw "sfdump --version returned empty" }

      - name: Test sf --version (alias)
        shell: pwsh
        run: |
          $sf = "${{ github.workspace }}\.venv\Scripts\sf.exe"
          $version = & $sf --version
          Write-Host "sf version: $version"
          if (-not $version) { throw "sf --version returned empty" }

      - name: Test sfdump --help shows all commands
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump --help..."
          $output = (& $sfdump --help) -join "`n"
          Write-Host $output

          $requiredCommands = @("login", "files", "verify-files", "build-db", "db-viewer")
          foreach ($cmd in $requiredCommands) {
              if ($output -notmatch $cmd) {
                  throw "Missing '$cmd' command in sfdump --help"
              }
              Write-Host "  [OK] Found '$cmd' command"
          }

      - name: Test venv activation works
        shell: pwsh
        run: |
          Write-Host "Testing venv activation..."

          # Activate the venv
          . "${{ github.workspace }}\.venv\Scripts\Activate.ps1"

          # Verify we're in the venv
          $pythonPath = (Get-Command python).Source
          Write-Host "Python path after activation: $pythonPath"

          if ($pythonPath -notmatch "\.venv") {
              throw "Python is not from venv after activation"
          }
          Write-Host "  [OK] Venv activation works"

          # Verify sfdump is available after activation
          $sfdumpPath = (Get-Command sfdump -ErrorAction SilentlyContinue).Source
          if (-not $sfdumpPath) {
              throw "sfdump not found in PATH after venv activation"
          }
          Write-Host "  [OK] sfdump available in PATH: $sfdumpPath"

          # Run sfdump from activated venv
          $version = sfdump --version
          Write-Host "  [OK] sfdump --version from activated venv: $version"

      - name: Test sfdump login --help
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $output = (& $sfdump login --help) -join "`n"
          Write-Host $output
          if ($output -notmatch "token") { throw "login --help missing expected content" }
          Write-Host "  [OK] sfdump login --help works"

      - name: Test sfdump files --help
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"
          $output = (& $sfdump files --help) -join "`n"
          Write-Host $output
          if ($output -notmatch "Download") { throw "files --help missing expected content" }
          Write-Host "  [OK] sfdump files --help works"

      - name: Test sfdump login runs (no credentials)
        shell: pwsh
        run: |
          $sfdump = "${{ github.workspace }}\.venv\Scripts\sfdump.exe"

          Write-Host "Testing sfdump login (expecting credential error)..."

          # Clear any env vars that might exist
          $env:SF_CLIENT_ID = ""
          $env:SF_CLIENT_SECRET = ""
          $env:SF_LOGIN_URL = ""

          # Run login - should fail with missing credentials error
          $output = (& $sfdump login 2>&1) -join "`n"
          $exitCode = $LASTEXITCODE

          Write-Host "Output: $output"
          Write-Host "Exit code: $exitCode"

          # Verify it failed with the expected error (not a crash)
          if ($output -notmatch "SF_CLIENT_ID|SF_LOGIN_URL|Missing|credentials") {
              throw "sfdump login didn't produce expected credential error"
          }

          if ($exitCode -eq 0) {
              throw "sfdump login should have failed without credentials"
          }

          Write-Host "  [OK] sfdump login runs correctly (fails gracefully without credentials)"

          # Reset exit code so the step passes
          exit 0

  # Test pip install from PyPI and verify commands work
  test-full-e2e:
    runs-on: windows-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install sfdump from PyPI
        shell: pwsh
        run: |
          Write-Host "Installing sfdump from PyPI..."
          python -m pip install --upgrade pip
          python -m pip install sfdump
          if ($LASTEXITCODE -ne 0) { throw "pip install sfdump failed" }
          Write-Host "  [OK] sfdump installed from PyPI"

      - name: Verify sfdump and sf commands exist
        shell: pwsh
        run: |
          Write-Host "Checking commands..."

          $sfdumpPath = (Get-Command sfdump -ErrorAction SilentlyContinue).Source
          if (-not $sfdumpPath) { throw "sfdump not found in PATH" }
          Write-Host "  [OK] sfdump found: $sfdumpPath"

          $sfPath = (Get-Command sf -ErrorAction SilentlyContinue).Source
          if (-not $sfPath) { throw "sf not found in PATH" }
          Write-Host "  [OK] sf found: $sfPath"

      - name: Test sfdump --version
        shell: pwsh
        run: |
          $version = sfdump --version
          Write-Host "sfdump version: $version"
          if (-not $version) { throw "sfdump --version returned empty" }

      - name: Test sf --version (alias)
        shell: pwsh
        run: |
          $version = sf --version
          Write-Host "sf version: $version"
          if (-not $version) { throw "sf --version returned empty" }

      - name: Test sfdump --help shows all commands
        shell: pwsh
        run: |
          Write-Host "Testing sfdump --help..."
          $output = (sfdump --help) -join "`n"
          Write-Host $output

          $requiredCommands = @("login", "files", "verify-files", "build-db", "db-viewer")
          foreach ($cmd in $requiredCommands) {
              if ($output -notmatch $cmd) {
                  throw "Missing '$cmd' command in sfdump --help"
              }
              Write-Host "  [OK] Found '$cmd' command"
          }

      - name: Test sfdump login runs (no credentials)
        shell: pwsh
        run: |
          Write-Host "Testing sfdump login (expecting credential error)..."

          $env:SF_CLIENT_ID = ""
          $env:SF_CLIENT_SECRET = ""
          $env:SF_LOGIN_URL = ""

          $output = (sfdump login 2>&1) -join "`n"
          $exitCode = $LASTEXITCODE

          Write-Host "Output: $output"
          Write-Host "Exit code: $exitCode"

          if ($output -notmatch "SF_CLIENT_ID|SF_LOGIN_URL|Missing|credentials") {
              throw "sfdump login didn't produce expected credential error"
          }

          Write-Host "  [OK] sfdump login runs correctly (fails gracefully without credentials)"
          exit 0

  # Test the release download flow (simulates fresh user experience)
  test-release-download:
    runs-on: windows-latest
    steps:
      # Don't checkout - simulating a fresh user machine

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Test bootstrap.ps1 can be downloaded
        shell: pwsh
        run: |
          Write-Host "Testing bootstrap.ps1 download from GitHub..."
          $script = irm https://raw.githubusercontent.com/ksteptoe/sfdump/main/bootstrap.ps1
          if (-not $script) { throw "Failed to download bootstrap.ps1" }
          if ($script -notmatch "sfdump") { throw "Downloaded content doesn't look like bootstrap.ps1" }
          Write-Host "Bootstrap script downloaded successfully ($($script.Length) bytes)"

      - name: Test pip install sfdump from PyPI
        shell: pwsh
        run: |
          Write-Host "Installing sfdump from PyPI..."
          python -m pip install sfdump
          if ($LASTEXITCODE -ne 0) { throw "pip install sfdump failed" }

          $version = sfdump --version
          Write-Host "  [OK] sfdump $version installed from PyPI"

          # Verify sf alias works too
          $sfVersion = sf --version
          Write-Host "  [OK] sf $sfVersion works"

      - name: Verify setup.ps1 .env template content
        shell: pwsh
        run: |
          Write-Host "Checking .env template in setup.ps1 from GitHub..."

          $content = irm https://raw.githubusercontent.com/ksteptoe/sfdump/main/setup.ps1
          if (-not $content) { throw "Failed to download setup.ps1" }

          # Verify correct environment variables are in the template
          $requiredVars = @(
              "SF_AUTH_FLOW=client_credentials",
              "SF_CLIENT_ID=",
              "SF_CLIENT_SECRET=",
              "SF_LOGIN_URL="
          )

          foreach ($var in $requiredVars) {
              if ($content -notmatch [regex]::Escape($var)) {
                  throw "Missing '$var' in .env template"
              }
              Write-Host "  [OK] Found '$var' in template"
          }

          # Verify OLD variables are NOT in the template
          $oldVars = @("SF_HOST=", "SF_USERNAME=", "SF_PASSWORD=")
          foreach ($var in $oldVars) {
              if ($content -match [regex]::Escape($var)) {
                  throw "Old variable '$var' still in .env template - should use Client Credentials flow"
              }
              Write-Host "  [OK] Old variable '$var' not in template"
          }

          Write-Host ""
          Write-Host ".env template is correct!" -ForegroundColor Green
